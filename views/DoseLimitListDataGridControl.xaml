<UserControl x:Class="nnunet_client.views.DoseLimitListDataGridControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:models="clr-namespace:nnunet_client.models"
             xmlns:System="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d" 
             d:DesignHeight="1000" d:DesignWidth="1000"
             x:Name="rootControl">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/StandardStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <Style x:Key="RowTextBlockStyle" TargetType="{x:Type TextBlock}">
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="Padding" Value="5,0"/>
            </Style>

            <Style x:Key="RowTextBoxStyle" TargetType="{x:Type TextBox}">
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="Padding" Value="5,0"/>
            </Style>

            <Style x:Key="ResultTextBlockStyle" TargetType="TextBlock" BasedOn="{StaticResource RowTextBlockStyle}">
                <Setter Property="Foreground" Value="Green"/>

                <Style.Triggers>

                    <!-- Trigger for "Fail" -->
                    <!-- The DataTrigger binds directly to the 'Result' property of the row's data context -->
                    <DataTrigger Binding="{Binding Result}" Value="Fail">
                        <Setter Property="Foreground" Value="Red" />
                    </DataTrigger>

                    <!-- Trigger for "Acceptable" -->
                    <DataTrigger Binding="{Binding Result}" Value="Acceptable">
                        <Setter Property="Foreground" Value="Blue" />
                    </DataTrigger>

                </Style.Triggers>
            </Style>



            <Style x:Key="LimitTextBlockStyle" TargetType="{x:Type TextBlock}" BasedOn="{StaticResource RowTextBlockStyle}">
                <Style.Triggers>
                    <DataTrigger Binding="{Binding LimitValid}" Value="False">
                        <Setter Property="Foreground" Value="Red"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="LimitTextBoxStyle" TargetType="{x:Type TextBox}" BasedOn="{StaticResource RowTextBoxStyle}">
                <Style.Triggers>
                    <DataTrigger Binding="{Binding LimitValid}" Value="False">
                        <Setter Property="Foreground" Value="Red"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>

        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Table -->
        <DataGrid Grid.Row="0"
                  ItemsSource="{Binding DoseLimits}"
                  SelectedItem="{Binding SelectedDoseLimit}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False">
            <DataGrid.Columns>
                

                <DataGridTextColumn Header="ID"
                    Binding="{Binding Id, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    ElementStyle="{StaticResource RowTextBlockStyle}"   
                    EditingElementStyle="{StaticResource RowTextBoxStyle}"   
                    Width="*"/>
                
                <DataGridTemplateColumn Header="Plan Contour">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Contour.Id}" VerticalAlignment="Center" Margin="0, 4" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ComboBox 
                                ItemsSource="{Binding DataContext.Contours, ElementName=rootControl}"
                                DisplayMemberPath="Id"
                                SelectedItem="{Binding Contour, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                Margin="0, 4"      
                                />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- no contour type for now... not sure where it is used...
                <DataGridTemplateColumn Header="Contour Type">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding ContourType}" VerticalAlignment="Center" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ComboBox 
                                SelectedItem="{Binding ContourType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                ItemsSource="{x:Static models:EnumHelper.DoseLimitContourTypes}"
                                      />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>
                -->
                <DataGridTemplateColumn Header="Prescription">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Prescription.Id}" VerticalAlignment="Center" Margin="0, 4" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ComboBox 
                                ItemsSource="{Binding DataContext.Prescriptions, ElementName=rootControl}"
                                DisplayMemberPath="Id"
                                SelectedItem="{Binding Prescription, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                Margin="0, 4"
                                />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn Header="Limit"
                    Binding="{Binding Limit, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    ElementStyle="{StaticResource LimitTextBlockStyle}"   
                    EditingElementStyle="{StaticResource LimitTextBoxStyle}"   
                    Width="*"/>

                <DataGridTextColumn Header="Value"
                    Binding="{Binding Value.Display, Mode=OneWay}"
                                                        ElementStyle="{StaticResource RowTextBlockStyle}"   
                    Width="*"/>

                <DataGridTextColumn 
                    Header="Result"
                    Binding="{Binding Result, Mode=OneWay}"
                    ElementStyle="{StaticResource ResultTextBlockStyle}"
                    Width="*"/>

                <DataGridTextColumn Header="Comments"
                    Binding="{Binding Comments, Mode=TwoWay}"
                                    ElementStyle="{StaticResource RowTextBlockStyle}"   
                                    EditingElementStyle="{StaticResource RowTextBoxStyle}"
                    Width="*"/>

                <DataGridTextColumn Header="Error"
                    Binding="{Binding ErrorMessage, Mode=OneWay}"
                                    Foreground="Red"
                                    ElementStyle="{StaticResource RowTextBlockStyle}"
                    Width="*"/>

            </DataGrid.Columns>
        </DataGrid>

        <!-- Dose Limit Item Editor (hidden) -->
        <StackPanel Grid.Row="1" Orientation="Vertical" Margin="0,10,0,0">
            <Grid Margin="5" Visibility="Collapsed">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Label Content="ID:" Grid.Column="0" VerticalAlignment="Center"/>
                <TextBox Text="{Binding SelectedDoseLimit.Id, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Grid.Column="1" Margin="5"/>

                <Label Content="Contour ID:" Grid.Column="2" VerticalAlignment="Center"/>
                <TextBox Text="{Binding SelectedDoseLimit.ContourId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Grid.Column="3" Margin="5"/>

                <Label Content="Contour Type:" Grid.Column="4" VerticalAlignment="Center"/>
                <ComboBox Grid.Column="5" Margin="5"
                          SelectedItem="{Binding SelectedDoseLimit.ContourType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          ItemsSource="{x:Static models:EnumHelper.DoseLimitContourTypes}" />

                <Label Content="Limit:" Grid.Column="6" VerticalAlignment="Center"/>
                <TextBox Text="{Binding SelectedDoseLimit.Limit, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Grid.Column="7" Margin="5"/>

                <Label Content="Comments:" Grid.Column="8" VerticalAlignment="Center"/>
                <TextBox Text="{Binding SelectedDoseLimit.Comments, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    Grid.Column="9" Margin="5"/>
            </Grid>

            <!-- Comments -->
            <!--
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="Notes:" VerticalAlignment="Center"/>
                <TextBox Grid.Column="1"
                         Text="{Binding Comments, Mode=TwoWay}" 
                         Margin="10"
                         Padding="5"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         VerticalScrollBarVisibility="Auto"
                         HorizontalScrollBarVisibility="Auto"
                         VerticalAlignment="Stretch"
                         Height="30"/>
            </Grid>
            -->
            <!-- Buttons -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="Add"
                        Command="{Binding AddCommand}"
                        Width="75"
                        Margin="5"/>
                <Button Content="Remove"
                        Command="{Binding RemoveCommand}"
                        Width="75"
                        Margin="5"/>

                <Button Content="Duplicate"
                        Command="{Binding DuplicateCommand}"
                        Width="75"
                        Margin="5"/>

                <Button Content="Save"
                        Command="{Binding SaveCommand}"
                        Visibility="{Binding SaveLoadButtonsVisibility}"
                        Width="75"
                        Margin="5"/>
                <Button Content="Load"
                        Command="{Binding LoadCommand}"
                        Visibility="{Binding SaveLoadButtonsVisibility}"
                        Width="75"
                        Margin="5"/>
            </StackPanel>
        </StackPanel>



    </Grid>
</UserControl>